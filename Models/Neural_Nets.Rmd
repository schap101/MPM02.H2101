---
title: "Neural Net"
output: html_notebook
author: "RÃ©gis Michael Andreoli"
---


1.1 Set up - Load libraries & Data preparation

2.1 Split data into train and test partition

3.1 First Model - Train & compare - with diversed predictors
3.2 First Model - Test best model
3.2 First Model - Finetune best model
3.3 First Model - Test final model

4.1 Second Model - Train & compare - only as time series
4.2 Second Model - Test best model
4.3 Second Model - Finetune best model
4.4 Second Model - Test final model

5.1 Create SARIMA model and compare with best second model


--------------------------------------------------------------------------------
#1.1 Set up - Load libraries & Data preparation

##1.1 Load libraries
```{r, echo= FALSE}
library(tidyverse)
library(neuralnet)
library(caret)
library(rstudioapi)
library(rmarkdown)
library(dplyr)
```

##1.1 Load data
```{r, echo= FALSE}
d <- setwd(dirname(getActiveDocumentContext()$path))
df <- read.csv("../Data/hour.csv")
```

##1.1 Decompose multi factor variable into single factor variable
```{r, echo= FALSE}
df$season_1 <- ifelse(df$season == "1", 1, 0)
df$season_2 <- ifelse(df$season == "2", 1, 0)
df$season_3 <- ifelse(df$season == "3", 1, 0)
df$season_4 <- ifelse(df$season == "4", 1, 0)
df$weathersit_1 <- ifelse(df$weathersit == "1", 1, 0)
df$weathersit_2 <- ifelse(df$weathersit == "2", 1, 0)
df$weathersit_3 <- ifelse(df$weathersit == "3", 1, 0)
df$weathersit_4 <- ifelse(df$weathersit == "4", 1, 0)
df$hr_0 <- ifelse(df$hr == "0", 1, 0)
df$hr_1 <- ifelse(df$hr == "1", 1, 0)
df$hr_2 <- ifelse(df$hr == "2", 1, 0)
df$hr_3 <- ifelse(df$hr == "3", 1, 0)
df$hr_4 <- ifelse(df$hr == "4", 1, 0)
df$hr_5 <- ifelse(df$hr == "5", 1, 0)
df$hr_6 <- ifelse(df$hr == "6", 1, 0)
df$hr_7 <- ifelse(df$hr == "7", 1, 0)
df$hr_8 <- ifelse(df$hr == "8", 1, 0)
df$hr_9 <- ifelse(df$hr == "9", 1, 0)
df$hr_10 <- ifelse(df$hr == "10", 1, 0)
df$hr_11 <- ifelse(df$hr == "11", 1, 0)
df$hr_12 <- ifelse(df$hr == "12", 1, 0)
df$hr_13 <- ifelse(df$hr == "13", 1, 0)
df$hr_14 <- ifelse(df$hr == "14", 1, 0)
df$hr_15 <- ifelse(df$hr == "15", 1, 0)
df$hr_16 <- ifelse(df$hr == "16", 1, 0)
df$hr_17 <- ifelse(df$hr == "17", 1, 0)
df$hr_18 <- ifelse(df$hr == "18", 1, 0)
df$hr_19 <- ifelse(df$hr == "19", 1, 0)
df$hr_20 <- ifelse(df$hr == "20", 1, 0)
df$hr_21 <- ifelse(df$hr == "21", 1, 0)
df$hr_22 <- ifelse(df$hr == "22", 1, 0)
df$hr_23 <- ifelse(df$hr == "23", 1, 0)
df$weekday_1 <- ifelse(df$weekday == "1", 1, 0)
df$weekday_2 <- ifelse(df$weekday == "2", 1, 0)
df$weekday_3 <- ifelse(df$weekday == "3", 1, 0)
df$weekday_4 <- ifelse(df$weekday == "4", 1, 0)
df$weekday_5 <- ifelse(df$weekday == "5", 1, 0)
df$weekday_6 <- ifelse(df$weekday == "6", 1, 0)
df$weekday_7 <- ifelse(df$weekday == "7", 1, 0)
```

##1.1 Normalize dependent var
```{r}
data <- df
data$cnt <- (df$cnt - min(df$cnt)) / (max(df$cnt) - min(df$cnt))
str(data)
```

##1.1 Identifying near-zero variance variable
```{r}
nearZeroVar(data, saveMetrics = TRUE)
```

#3.1 Model 1

##3.1 Split data into train and test partition
```{r}
set.seed(123)
indices_1 <- createDataPartition(data$cnt, p=.65, list = F)

train_1 <- data %>% slice(indices_1)
test_1 <- data %>% slice(-indices_1)

str(train_1)
```


##3.1 Model 1 - Set up
```{r}
set.seed(44)
tuGrid_1 <- expand.grid(.layer1=c(1,2,4:8), .layer2=c(0,2,3,4), .layer3=c(0,2))

trCtrl_1 <- trainControl(
  method = 'repeatedcv',
  number = 5,
  repeats = 1,
  returnResamp = 'final'
)
```

##3.1 Model 1 - Train and Compare
```{r}#
models_1 <- train(cnt ~ hum + temp + weathersit_1 + weathersit_2 + weathersit_3 + hr_1 + hr_2 + hr_3 + hr_4 + hr_5 + hr_6 + hr_7 + hr_8 + hr_9 + hr_10 + hr_11 + hr_12 + hr_13 + hr_14 + hr_15 + hr_16 + hr_17 + hr_18 + hr_19 + hr_20 + hr_21 + hr_22 + hr_23, data = train,
  method = 'neuralnet',
  metric = 'RMSE',
  linear.output = TRUE,
  threshold = 0.1,
  lifesign.step = 1000,
  lifesign = "full",
  preProcess = c('center', 'scale'),
  tuneGrid = tuGrid_1,
  trControl = trCtrl_1
  )
```

##3.1 Model 1 - Save and Load
```{r}#
saveRDS(models_1, "neural_nets_models_1.rds")
```

```{r}
models_1 <-readRDS("neural_nets_models_1.rds")
```

```{r}
plot(models_1)
```

##3.1 Model 1 - Compute Prediction
```{r}
pred_1 <- compute(models_1$finalModel, test_1 %>% select(-cnt))
pred_1 <- pred_1$net.result * (max(df$cnt) - min(df$cnt)) + min(df$cnt)
control_1 <- test$cnt * (max(df$cnt) - min(df$cnt)) + min(df$cnt)
head(pred_1)
head(control_1)
```

##3.1 Model 1 - Root Mean Square
```{r}
sqrt(mean((control_1 - pred_1)^2))
```

##3.1 Model 1 - Plot Model Performance
```{r}
plot(control_1, pred_1, col='orange', cex = .3, pch=20, ylab = "predicted rating NN", xlab = "real rating")
abline(0,1)
```

#3.2 Model 2

##3.2 Split data into train and test partition
```{r}
set.seed(42)
indices_2 <- createDataPartition(data$cnt, p=.8, list = F)

train_2 <- data %>% slice(indices_2)
test_2 <- data %>% slice(-indices_2)
```

##3.2 Model 2 - Set up
```{r}
set.seed(42)
model_2 = neuralnet(cnt ~ hum + temp + weathersit_1 + weathersit_2 + weathersit_3 + hr_1 + hr_2 + hr_3 + hr_4 + hr_5 + hr_6 + hr_7 + hr_8 + hr_9 + hr_10 + hr_11 + hr_12 + hr_13 + hr_14 + hr_15 + hr_16 + hr_17 + hr_18 + hr_19 + hr_20 + hr_21 + hr_22 + hr_23, data = train_2, hidden = 4,linear.output = TRUE, threshold = 0.01, stepmax = 500000, lifesign.step = 1000, lifesign = "full")
```

##3.2 Model 2 - Save and Load
```{r}#
saveRDS(model_2, "neural_nets_model_2.rds")
```

```{r}
model_2 <-readRDS("neural_nets_model_2.rds")
```

##3.1 Model 1 - Compute Prediction
```{r}
pred_2 <- compute(model_2, test_2 %>% select(-cnt))
pred_2 <- pred_2$net.result * (max(df$cnt) - min(df$cnt)) + min(df$cnt)
control_2 <- test_2$cnt * (max(df$cnt) - min(df$cnt)) + min(df$cnt)
head(pred_2)
head(control_2)
```

##3.2 Model 2 - Root Mean Square
```{r}
sqrt(mean((control_2 - pred_2)^2))
```

##3.2 Model 2 - Plot Model Performance
```{r}
plot(control_2, pred_2, col='orange', cex = .3, pch=20, ylab = "predicted rating NN", xlab = "real rating")
abline(0,1)
```

